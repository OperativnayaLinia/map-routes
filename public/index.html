<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ú–∞—Ä—à—Ä—É—Ç—ã</title>
<meta name="viewport" content="width=device-width">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
height:100%;
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
}
#map{position:absolute;inset:0}

/* –ø–∞–Ω–µ–ª—å */
.controls{
position:absolute;
top:10px;
left:10px;
z-index:1000;
display:none;
gap:6px;
flex-wrap:wrap;
}
.controls button{
padding:8px 12px;
border:none;
border-radius:8px;
background:#0078ff;
color:#fff;
font-weight:600;
cursor:pointer;
}
.controls button.active{background:#ff9800}

/* –≤—Ö–æ–¥ */
.admin-login{
position:absolute;
top:10px;
right:10px;
z-index:1000;
}
.admin-login button{
padding:6px 12px;
border-radius:8px;
border:none;
background:#222;
color:#fff;
}

/* —Ç–æ—á–∫–∞ */
.dot{
width:14px;
height:14px;
background:#ff0000;
border-radius:50%;
box-shadow:0 0 6px rgba(255,0,0,.9);
}

/* –ø–æ–¥–ø–∏—Å—å */
.credit{
position:absolute;
bottom:6px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,.65);
color:#fff;
padding:4px 10px;
border-radius:6px;
font-size:13px;
z-index:1000;
}
.credit a{color:#00b7ff;text-decoration:none}
</style>
</head>

<body>

<div id="map"></div>

<div class="admin-login">
<button id="loginBtn">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
</div>

<div class="controls" id="controls">
<button id="start">–°—Ç–∞—Ä—Ç</button>
<button id="pause">–ü–∞—É–∑–∞</button>
<button id="reset">–°–±—Ä–æ—Å</button>
<button id="addPointBtn">‚ûï –¢–æ—á–∫–∞</button>
<button id="editRouteBtn">‚úèÔ∏è –ú–∞—Ä—à—Ä—É—Ç</button>
<button id="deleteRouteBtn">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div class="credit">
–ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª–∞
<a href="https://t.me/Bel_linia_31" target="_blank">
–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è
</a>
</div>

<script>
let adminToken=null;

/* ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===== */
loginBtn.onclick=()=>{
const p=prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
if(p!=="Bel_admin31") return;

fetch('/api/admin/login',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({password:p})
}).then(r=>r.ok&&r.json()).then(d=>{
if(d){
adminToken=d.token;
controls.style.display='flex';
loginBtn.style.display='none';
}
});
};

/* ===== –ö–ê–†–¢–ê ===== */
const map=L.map("map",{attributionControl:false})
.setView([50.5954,36.5873],9);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const pointIcon=L.divIcon({
html:'<div class="dot"></div>',
className:"",
iconSize:[14,14],
iconAnchor:[7,7]
});

/* ===== –î–ê–ù–ù–´–ï ===== */
let routes=[];
let activeRoute=null;
let isRunning=false;
let animationFrame=null;
let addPointMode=false;
let editRouteMode=false;
let deleteRouteMode=false;
const speed=0.0004;

/* ===== –ó–ê–ì–†–£–ó–ö–ê –° –°–ï–†–í–ï–†–ê ===== */
function loadRoutes(){
fetch('/api/routes').then(r=>r.json()).then(data=>{
clearMap();
data.forEach(r=>{
const polyline=L.polyline(r.path,{color:"blue"}).addTo(map);
const marker=L.marker(r.path[0],{icon:pointIcon}).addTo(map);
attachMarkerEvents(marker);
routes.push({path:r.path,polyline,marker,progress:0,id:r.id});
});
});
}
loadRoutes();

/* ===== –û–ß–ò–°–¢–ö–ê ===== */
function clearMap(){
routes.forEach(r=>{
map.removeLayer(r.marker);
map.removeLayer(r.polyline);
});
routes=[];
activeRoute=null;
}

/* ===== –ö–õ–ò–ö –ü–û –ö–ê–†–¢–ï ===== */
map.on("click",e=>{
if(!adminToken) return;
if(!addPointMode && !editRouteMode && !e.originalEvent.ctrlKey) return;

const point=[e.latlng.lat,e.latlng.lng];

if(e.originalEvent.ctrlKey) activeRoute=null;
if(addPointMode) activeRoute=null;
if(editRouteMode && !activeRoute) return;

if(activeRoute){
activeRoute.path.push(point);
activeRoute.polyline.setLatLngs(activeRoute.path);
}else{
const polyline=L.polyline([point],{color:"blue"}).addTo(map);
const marker=L.marker(point,{icon:pointIcon}).addTo(map);
const route={path:[point],polyline,marker,progress:0};
routes.push(route);
activeRoute=route;
attachMarkerEvents(marker);
}

if(addPointMode){
addPointMode=false;
addPointBtn.classList.remove("active");
}
});

/* ===== –ú–ê–†–ö–ï–† ===== */
function attachMarkerEvents(marker){
marker.on("click",()=>{
if(!adminToken) return;
activeRoute=routes.find(r=>r.marker===marker);

if(deleteRouteMode && activeRoute){
if(confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?")){
deleteRoute(activeRoute);
}
deleteRouteMode=false;
deleteRouteBtn.classList.remove("active");
}
});
}

/* ===== –£–î–ê–õ–ï–ù–ò–ï ===== */
function deleteRoute(route){
map.removeLayer(route.marker);
map.removeLayer(route.polyline);
routes=routes.filter(r=>r!==route);
if(route.id){
fetch('/api/routes/'+route.id,{
method:'DELETE',
headers:{'x-admin-token':adminToken}
});
}
activeRoute=null;
}

/* ===== –ê–ù–ò–ú–ê–¶–ò–Ø ===== */
function animate(){
if(!isRunning) return;
routes.forEach(r=>{
if(r.path.length<2) return;
const i=Math.floor(r.progress);
const t=r.progress-i;
if(i>=r.path.length-1) r.progress=0;
const a=r.path[i];
const b=r.path[(i+1)%r.path.length];
r.marker.setLatLng([
a[0]+(b[0]-a[0])*t,
a[1]+(b[1]-a[1])*t
]);
r.progress+=speed;
});
animationFrame=requestAnimationFrame(animate);
}

/* ===== –ö–ù–û–ü–ö–ò ===== */
start.onclick=()=>{
isRunning=true;
routes.forEach(r=>r.progress=0);
animate();
};
pause.onclick=()=>{
isRunning=false;
cancelAnimationFrame(animationFrame);
};
reset.onclick=()=>{
if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã?")) return;
routes.forEach(r=>{
if(r.id){
fetch('/api/routes/'+r.id,{
method:'DELETE',
headers:{'x-admin-token':adminToken}
});
}
});
clearMap();
};

addPointBtn.onclick=()=>{
addPointMode=!addPointMode;
editRouteMode=false;
deleteRouteMode=false;
addPointBtn.classList.toggle("active",addPointMode);
editRouteBtn.classList.remove("active");
deleteRouteBtn.classList.remove("active");
};

editRouteBtn.onclick=()=>{
editRouteMode=!editRouteMode;
addPointMode=false;
deleteRouteMode=false;
editRouteBtn.classList.toggle("active",editRouteMode);
addPointBtn.classList.remove("active");
deleteRouteBtn.classList.remove("active");
};

deleteRouteBtn.onclick=()=>{
deleteRouteMode=!deleteRouteMode;
addPointMode=false;
editRouteMode=false;
deleteRouteBtn.classList.toggle("active",deleteRouteMode);
addPointBtn.classList.remove("active");
editRouteBtn.classList.remove("active");
};
</script>

</body>
</html>

