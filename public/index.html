<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ú–∞—Ä—à—Ä—É—Ç—ã</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
}

#map {
  position: absolute;
  inset: 0;
}

/* –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
.controls {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  display: none;
  gap: 6px;
  flex-wrap: wrap;
}

.controls button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background: #0078ff;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
}

.controls button.active {
  background: #ff9800;
}

/* –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
.admin-login {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
}

.admin-login button {
  padding: 6px 12px;
  border-radius: 8px;
  border: none;
  background: #222;
  color: #fff;
  cursor: pointer;
}

/* —Ç–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
.dot {
  width: 14px;
  height: 14px;
  background: red;
  border-radius: 50%;
  box-shadow: 0 0 6px rgba(255,0,0,0.9);
}
</style>
</head>

<body>

<div id="map"></div>

<div class="admin-login">
  <button id="loginBtn">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
</div>

<div class="controls" id="controls">
  <button id="start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
  <button id="pause">‚è∏ –ü–∞—É–∑–∞</button>
  <button id="addPointBtn">‚ûï –¢–æ—á–∫–∞</button>
  <button id="deleteRouteBtn">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<script>
let adminToken = null;

/* ===== –õ–û–ì–ò–ù ===== */
loginBtn.onclick = () => {
  const p = prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
  if (!p) return;

  fetch('/api/admin/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: p })
  })
  .then(r => r.ok && r.json())
  .then(d => {
    if (d) {
      adminToken = d.token || "ok";
      controls.style.display = "flex";
      loginBtn.style.display = "none";
    }
  });
};

/* ===== –ö–ê–†–¢–ê ===== */
const map = L.map('map').setView([50.5954, 36.5873], 9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: ''
}).addTo(map);

/* ===== –ò–ö–û–ù–ö–ê –¢–û–ß–ö–ò (–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ===== */
const pointIcon = L.divIcon({
  html: '<div class="dot"></div>',
  className: '',
  iconSize: [14, 14],
  iconAnchor: [7, 7]
});

/* ===== –î–ê–ù–ù–´–ï ===== */
let routes = [];
let activeRoute = null;
let isRunning = false;
let addPointMode = false;
let deleteRouteMode = false;
const speed = 0.0004;

/* ===== –ö–õ–ò–ö –ü–û –ö–ê–†–¢–ï ===== */
map.on('click', e => {
  if (!adminToken || !addPointMode) return;

  const point = [e.latlng.lat, e.latlng.lng];

  if (!activeRoute) {
    const polyline = L.polyline([point], { color: 'blue' }).addTo(map);
    const marker = L.marker(point, { icon: pointIcon }).addTo(map);
    attachMarkerEvents(marker);

    activeRoute = {
      path: [point],
      polyline,
      marker,
      progress: 0
    };

    routes.push(activeRoute);
  } else {
    activeRoute.path.push(point);
    activeRoute.polyline.setLatLngs(activeRoute.path);
  }
});

/* ===== –°–û–ë–´–¢–ò–Ø –ú–ê–†–ö–ï–†–ê ===== */
function attachMarkerEvents(marker) {

  marker.on('click', () => {
    if (!adminToken) return;
    activeRoute = routes.find(r => r.marker === marker);

    if (deleteRouteMode && activeRoute) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) {
        deleteRoute(activeRoute);
      }
      deleteRouteMode = false;
      deleteRouteBtn.classList.remove('active');
    }
  });

  marker.on('contextmenu', () => {
    if (!adminToken) return;
    const route = routes.find(r => r.marker === marker);
    if (route && confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) {
      deleteRoute(route);
    }
  });

  let holdTimer = null;
  marker.on('touchstart', () => {
    holdTimer = setTimeout(() => {
      const route = routes.find(r => r.marker === marker);
      if (route && confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) {
        deleteRoute(route);
      }
    }, 800);
  });
  marker.on('touchend', () => clearTimeout(holdTimer));
}

/* ===== –£–î–ê–õ–ï–ù–ò–ï ===== */
function deleteRoute(route) {
  map.removeLayer(route.marker);
  map.removeLayer(route.polyline);
  routes = routes.filter(r => r !== route);
  activeRoute = null;
}

/* ===== –ê–ù–ò–ú–ê–¶–ò–Ø ===== */
function animate() {
  if (!isRunning) return;

  routes.forEach(r => {
    if (r.path.length < 2) return;

    const i = Math.floor(r.progress);
    const t = r.progress - i;
    if (i >= r.path.length - 1) r.progress = 0;

    const a = r.path[i];
    const b = r.path[i + 1];

    r.marker.setLatLng([
      a[0] + (b[0] - a[0]) * t,
      a[1] + (b[1] - a[1]) * t
    ]);

    r.progress += speed;
  });

  requestAnimationFrame(animate);
}

/* ===== –ö–ù–û–ü–ö–ò ===== */
start.onclick = () => {
  isRunning = true;
  routes.forEach(r => r.progress = 0);
  animate();
};

pause.onclick = () => isRunning = false;

addPointBtn.onclick = () => {
  addPointMode = !addPointMode;
  deleteRouteMode = false;
  addPointBtn.classList.toggle('active', addPointMode);
  deleteRouteBtn.classList.remove('active');
};

deleteRouteBtn.onclick = () => {
  deleteRouteMode = !deleteRouteMode;
  addPointMode = false;
  deleteRouteBtn.classList.toggle('active', deleteRouteMode);
  addPointBtn.classList.remove('active');
};
</script>

</body>
</html>
